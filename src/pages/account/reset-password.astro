---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Återställ lösenord - Feed Zone">
  <div class="container mx-auto px-4 py-12">
    <div class="max-w-md mx-auto">
      <h1 class="text-4xl font-bold text-primary !mb-5 text-center">Återställ lösenord</h1>
      
      <div class="bg-surface p-6">
        <div id="reset-form-container">
          <p class="text-text-muted !mb-4">
            Ange ett nytt lösenord för ditt konto.
          </p>
          
          <form id="reset-password-form" class="space-y-4">
            <div>
              <label for="password" class="block mb-2 font-semibold">Nytt lösenord</label>
              <input 
                type="password" 
                id="password" 
                name="password" 
                required 
                minlength="6"
                class="w-full border border-gray-300 rounded !px-2 !py-1"
              />
              <p class="text-sm text-text-muted mt-1">Måste vara minst 6 tecken</p>
            </div>
            <div>
              <label for="confirm-password" class="block mb-2 font-semibold">Bekräfta lösenord</label>
              <input 
                type="password" 
                id="confirm-password" 
                name="confirm-password" 
                required 
                class="w-full border border-gray-300 rounded !px-2 !py-1"
              />
            </div>
            <button 
              type="submit"
          class="w-full bg-indigo-950 hover:bg-indigo-900 text-white text-center rounded-lg font-semibold transition-all uppercase text-sm cursor-pointer !mt-6 !mb-4"
            style="padding: 0.875rem 1.5rem !important; color: white !important;"
            >
              Återställ lösenord
            </button>
          </form>
          
          <div class="mt-4 text-center">
            <p class="text-text-muted">
              <a href="/account/login" class="text-primary hover:text-accent">Tillbaka till inloggning</a>
            </p>
          </div>

          <div id="error-message" class="mt-4 text-red-600 hidden"></div>
          <div id="success-message" class="mt-4 text-green-600 hidden"></div>
        </div>

        <div id="invalid-link-container" class="hidden text-center">
          <p class="text-red-600 mb-4">Ogiltig eller saknad återställningslänk.</p>
          <p class="text-text-muted mb-4">
            Länken kan ha gått ut eller så är den ogiltig. Begär en ny återställningslänk.
          </p>
          <a 
            href="/account/forgot-password" 
            class="inline-block bg-accent text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity"
          >
            Begär ny länk
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase-client';
  
  if (typeof window !== 'undefined') {
    // Check if we have a valid session with recovery token
    // Supabase redirects with hash fragments: #access_token=...&type=recovery
    async function checkRecoverySession() {
      const resetFormContainer = document.getElementById('reset-form-container');
      const invalidLinkContainer = document.getElementById('invalid-link-container');
      
      // Check if URL has hash fragments (Supabase redirects with hash)
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const type = hashParams.get('type');
      
      if (type === 'recovery') {
        // Wait a moment for Supabase to process the hash and create session
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (session && !error) {
          // Valid recovery session
          if (resetFormContainer) resetFormContainer.classList.remove('hidden');
          if (invalidLinkContainer) invalidLinkContainer.classList.add('hidden');
          setupResetForm();
        } else {
          // Invalid or expired recovery token
          if (resetFormContainer) resetFormContainer.classList.add('hidden');
          if (invalidLinkContainer) invalidLinkContainer.classList.remove('hidden');
        }
      } else {
        // No recovery token in URL
        if (resetFormContainer) resetFormContainer.classList.add('hidden');
        if (invalidLinkContainer) invalidLinkContainer.classList.remove('hidden');
      }
    }

    function setupResetForm() {
      const form = document.getElementById('reset-password-form') as HTMLFormElement;
      
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(form);
          const password = formData.get('password') as string;
          const confirmPassword = formData.get('confirm-password') as string;

          const errorMessage = document.getElementById('error-message');
          const successMessage = document.getElementById('success-message');
          const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

          // Hide previous messages
          if (errorMessage) {
            errorMessage.classList.add('hidden');
            errorMessage.textContent = '';
          }
          if (successMessage) {
            successMessage.classList.add('hidden');
            successMessage.textContent = '';
          }

          if (password !== confirmPassword) {
            if (errorMessage) {
              errorMessage.classList.remove('hidden');
              errorMessage.textContent = 'Lösenorden matchar inte';
            }
            return;
          }

          submitButton.disabled = true;
          submitButton.textContent = 'Återställer...';

          try {
            // Update password using current session
            const { error } = await supabase.auth.updateUser({
              password: password
            });

            if (error) {
              throw error;
            }

            // Show success message
            if (successMessage) {
              successMessage.classList.remove('hidden');
              successMessage.textContent = 'Ditt lösenord har återställts. Du kan nu logga in med ditt nya lösenord.';
            }

            // Redirect to login after 3 seconds
            setTimeout(() => {
              window.location.href = '/account/login';
            }, 3000);
          } catch (error: any) {
            if (errorMessage) {
              errorMessage.classList.remove('hidden');
              errorMessage.textContent = error.message || 'Ett fel uppstod vid återställning av lösenord';
            }
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Återställ lösenord';
          }
        });
      }
    }

    // Check on page load
    checkRecoverySession();
    
    // Also listen for hash changes (in case Supabase redirects after page load)
    window.addEventListener('hashchange', checkRecoverySession);
  }
</script>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
</style>


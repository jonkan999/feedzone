---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Sign Up - Feed Zone">
  <div class="container mx-auto px-4 py-12">
    <div class="max-w-md mx-auto">
      <h1 class="text-4xl font-bold text-primary mb-8 text-center">Skapa konto</h1>
      
      <div class="bg-surface p-6">
        <form id="signup-form" class="space-y-4">
          <div>
            <label for="email" class="block mb-2 font-semibold">Email</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required 
              class="w-full border border-gray-300 rounded !px-2 !py-1"
            />
          </div>
          <div>
            <label for="password" class="block mb-2 font-semibold">Lösenord</label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              required 
              minlength="6"
              class="w-full border border-gray-300 rounded !px-2 !py-1"
            />
            <p class="text-sm text-text-muted mt-1">Måste vara minst 6 tecken</p>
          </div>
          <div>
            <label for="confirm-password" class="block mb-2 font-semibold">Bekräfta lösenord</label>
            <input 
              type="password" 
              id="confirm-password" 
              name="confirm-password" 
              required 
              class="w-full border border-gray-300 rounded !px-2 !py-1"
            />
          </div>
          <button 
            type="submit"
            id="signup-submit-btn"
            class="w-full bg-indigo-950 hover:bg-indigo-900 text-white text-center rounded-lg font-semibold transition-all uppercase text-sm cursor-pointer"
            style="padding: 0.875rem 1.5rem !important; color: white !important;"
          >
            Skapa konto
          </button>
        </form>
        
        <div class="mt-4 text-center">
          <p class="text-text-muted">
            Har du redan ett konto? 
            <a href="/account/login" class="text-primary hover:text-accent">Logga in</a>
          </p>
        </div>

        <div id="error-message" class="mt-4 text-red-600 hidden"></div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase-client';
  
  if (typeof window !== 'undefined') {
    document.getElementById('signup-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const email = formData.get('email') as string;
      const password = formData.get('password') as string;
      const confirmPassword = formData.get('confirm-password') as string;

      const errorMessage = document.getElementById('error-message');
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

      if (password !== confirmPassword) {
        if (errorMessage) {
          errorMessage.textContent = 'Lösenorden matchar inte';
          errorMessage.classList.remove('hidden');
        }
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = 'Skapar konto...';

      try {
        const response = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const data = await response.json();

        if (response.ok) {
          // Check if email confirmation is required
          // If no session is returned, user needs to confirm email first
          if (!data.user?.email_confirmed_at && !data.session) {
            // Email confirmation required
            if (errorMessage) {
              errorMessage.classList.remove('hidden');
              errorMessage.classList.remove('text-red-600');
              errorMessage.classList.add('text-green-600');
              errorMessage.textContent = 'Ett bekräftelsemail har skickats till din e-postadress. Klicka på länken i mailet för att aktivera ditt konto.';
            }
            submitButton.disabled = false;
            submitButton.textContent = 'Skapa konto';
            return;
          }
          
          // If session exists, sign in immediately (email confirmation disabled)
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          
          if (error) {
            throw error;
          }

          window.location.href = '/account';
        } else {
          throw new Error(data.error || 'Signup failed');
        }
      } catch (error: any) {
        if (errorMessage) {
          errorMessage.textContent = error.message || 'Ett fel uppstod';
          errorMessage.classList.remove('hidden');
        }
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Skapa konto';
      }
    });
  }
</script>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  #signup-form button[type="submit"],
  #signup-submit-btn {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
</style>


---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Sign In - Feed Zone">
  <div class="container mx-auto px-4 py-12">
    <div class="max-w-md mx-auto">
      <h1 class="text-4xl font-bold text-primary mb-8 text-center">Logga in</h1>
      
      <div class="bg-surface p-6">
        <form id="login-form" class="space-y-4">
          <div>
            <label for="email" class="block mb-2 font-semibold">Email</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required 
              class="w-full border border-gray-300 rounded !px-4 !py-2"
            />
          </div>
          <div>
            <label for="password" class="block !mb-2 font-semibold">Lösenord</label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              required 
              class="w-full border border-gray-300 rounded !px-4 !py-2"
            />
            <div class="!mt-2 text-right">
              <a href="/account/forgot-password" class="text-sm text-primary hover:text-accent">
                Glömt lösenord?
              </a>
            </div>
          </div>
          <button 
            type="submit"
            id="login-submit-btn"
            class="w-full bg-indigo-950 hover:bg-indigo-900 text-white text-center rounded-lg font-semibold transition-all uppercase text-sm cursor-pointer"
            style="padding: 0.75rem 1rem !important; color: white !important;"
          >
            Logga in
          </button>
        </form>
        
        <div class="!mt-4 text-center">
          <p class="text-text-muted">
            Har du inget konto? 
            <a href="/account/signup" class="text-primary hover:text-accent">Registrera dig</a>
          </p>
        </div>

        <div id="error-message" class="mt-4 text-red-600 hidden"></div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase-client';
  
  if (typeof window !== 'undefined') {
    document.getElementById('login-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const email = formData.get('email') as string;
      const password = formData.get('password') as string;

      const errorMessage = document.getElementById('error-message');
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

      submitButton.disabled = true;
      submitButton.textContent = 'Loggar in...';

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        const data = await response.json();

        if (response.ok) {
          // Sign in with Supabase client-side to get session
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          
          if (error) {
            throw error;
          }

          window.location.href = '/account';
        } else {
          throw new Error(data.error || 'Login failed');
        }
      } catch (error: any) {
        if (errorMessage) {
          errorMessage.textContent = error.message || 'Ett fel uppstod';
          errorMessage.classList.remove('hidden');
        }
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Logga in';
      }
    });
  }
</script>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  #login-form button[type="submit"],
  #login-submit-btn {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
</style>


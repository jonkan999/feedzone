---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Checkout - Feed Zone">
  <div class="container mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold text-primary !mb-5">Kassa</h1>
    
    <div id="checkout-container">
      <p class="text-text-muted">Laddar...</p>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase-client';
  
  if (typeof window !== 'undefined') {
    async function fetchProductData(productId: string) {
      try {
        const response = await fetch(`/api/products/${productId}`);
        const product = await response.json();
        return product.error ? null : product;
      } catch (error) {
        console.error('Error fetching product:', error);
        return null;
      }
    }

    async function renderCheckout() {
      const container = document.getElementById('checkout-container');
      if (!container) return;

      // Check if user is logged in
      const { data: { session } } = await supabase.auth.getSession();
      const isLoggedIn = !!session;

      const cart = JSON.parse(localStorage.getItem('feedzone-cart') || '[]');
      
      if (cart.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <p class="text-text-muted text-xl mb-4">Din varukorg √§r tom</p>
            <a href="/products" class="inline-block bg-accent text-white px-6 py-3 rounded-lg hover:opacity-90 transition-opacity">
              Bl√§ddra produkter
            </a>
          </div>
        `;
        return;
      }

      // Fetch product data for all cart items + prioritized upsell product
      const productDataPromises = cart.map((item: any) => fetchProductData(item.product_id));
      const hydrapakProductPromise = fetchProductData('hydrapak-gel-soft-flask-250ml');
      const productDataArray = await Promise.all(productDataPromises);
      const hydrapakProduct = await hydrapakProductPromise;

      // Discount state
      let discount: { code: string; type: 'percent' | 'free_shipping' | 'fixed_amount'; value: number } | null = null;

      const shippingCost = 59; // PostNord shipping cost
      const freeShippingThreshold = 400;
      const stripeMinimum = 3; // Stripe minimum SEK
      function calcTotals() {
        const rawSubtotal = cart.reduce((sum: number, item: any, index: number) => {
          const productData = productDataArray[index];
          const itemPrice = productData?.price ?? item.price;
          return sum + (itemPrice * item.quantity);
        }, 0);

        const percentDiscount = discount?.type === 'percent'
          ? rawSubtotal * Math.min(Math.max(discount.value, 0), 100) / 100
          : 0;

        const remainingAfterPercent = rawSubtotal - percentDiscount;

        const fixedDiscount = discount?.type === 'fixed_amount'
          ? Math.min(Math.max(discount.value, 0), Math.max(0, remainingAfterPercent))
          : 0;

        const subtotal = Math.max(0, remainingAfterPercent - fixedDiscount);

        const isTestProduct = cart.some((item: any) => item.product_id === 'test-product-1sek');
        const qualifiesForFreeShipping = subtotal >= freeShippingThreshold || isTestProduct || discount?.type === 'free_shipping';
        const shipping = qualifiesForFreeShipping ? 0 : shippingCost;

        const total = subtotal + shipping;
        const discountAmount = percentDiscount + fixedDiscount;
        const remainingForFreeShipping = Math.max(0, freeShippingThreshold - subtotal);
        const belowStripeMinimum = total < stripeMinimum;

        return { rawSubtotal, subtotal, shipping, total, discountAmount, remainingForFreeShipping, qualifiesForFreeShipping, belowStripeMinimum };
      }

      const totals = calcTotals();
      const hydrapakUpsell = hydrapakProduct ?? {
        id: 'hydrapak-gel-soft-flask-250ml',
        name: 'HydraPak Gel Soft Flask 250ml',
        price: 129,
        image_url: '/images/products/hydrapak-gel-soft-flask-250ml/primary.jpg',
      };

      const doubleUpCandidate = cart.reduce((best: any, item: any, index: number) => {
        const productData = productDataArray[index];
        const price = productData?.price ?? item.price ?? 0;
        if (!best || price > (best.price ?? 0)) {
          return {
            id: item.product_id,
            name: productData?.name ?? item.product_name ?? 'Produkt',
            price,
            image_url: productData?.image_url ?? hydrapakUpsell.image_url,
          };
        }
        return best;
      }, null);

      const upsellItems = !totals.qualifiesForFreeShipping ? [
        {
          ...hydrapakUpsell,
          badge: 'Prova den!',
        },
        ...(doubleUpCandidate ? [{
          ...doubleUpCandidate,
          badge: 'Double up!',
          isDoubleUp: true,
        }] : []),
      ] : [];

      const upsellSection = upsellItems.length ? `
        <div id="upsell-wrapper" class="mb-4 ${totals.qualifiesForFreeShipping ? 'hidden' : ''}">
          <div class="flex items-center justify-between !mb-1">
            <p class="font-semibold text-lg">L√§gg till detta f√∂r att f√• fri frakt</p>
            <span class="text-sm text-gray-600" data-remaining-label>${totals.remainingForFreeShipping.toFixed(0)} SEK kvar</span>
          </div>
          <div class="!space-y-2 !mb-3">
            ${upsellItems.map((item: any) => `
              <div class="flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-lg hover:border-accent transition">
                <div class="relative w-20 h-20 flex-shrink-0">
                  <img src="${item.image_url}" alt="${item.name}" class="w-20 h-20 object-cover ">
                  <span class="absolute top-1 left-1 bg-indigo-950 text-white text-[11px] rounded-md !px-1">${item.badge}</span>
                </div>
                <div class="flex-1">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-semibold text-sm">${item.name}</div>
                      <div class="text-sm text-gray-700">${(item.price ?? 0).toFixed(2)} SEK</div>
                    </div>
                    <button 
                      type="button" 
                      class="js-add-upsell bg-indigo-950 text-white text-xs font-semibold !px-2 !py-1 rounded-md !mt-5 !mr-2 hover:bg-indigo-900 transition"
                      data-upsell-id="${item.id}"
                      data-upsell-name="${item.name}"
                      data-upsell-price="${item.price ?? 0}"
                    >
                      L√§gg till
                    </button>
                  </div>
                  ${item.isDoubleUp ? `<p class="text-xs text-gray-600 mt-1">L√§gg till en till av din favorit.</p>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : '';

      container.innerHTML = `
        ${!isLoggedIn ? `
          <div class="bg-blue-50 border border-blue-200 rounded-lg !p-2 !mt-2 !!mb-4">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-800 font-semibold mb-1">Logga in f√∂r en smidigare upplevelse</p>
                <p class="text-blue-600 text-sm">Spara din orderhistorik och f√• snabbare checkout n√§sta g√•ng</p>
              </div>
              <a href="/account/login?redirect=/checkout" class="text-blue-600 hover:text-blue-800 font-semibold underline whitespace-nowrap ml-4">
                Logga in
              </a>
            </div>
          </div>
        ` : ''}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div>
            <div class="bg-surface p-6 !mb-4">
              <h2 class="text-2xl font-bold mb-4">Fraktinformation</h2>
              <form id="shipping-form" class="space-y-4">
                <div>
                  <label for="email" class="block mb-2 font-semibold">Email</label>
                  <input type="email" id="email" name="email" required class="w-full border border-gray-300 rounded !px-2 !py-1" value="${isLoggedIn && session?.user?.email ? session.user.email : ''}">
                </div>
                <div>
                  <label for="name" class="block mb-2 font-semibold">Fullst√§ndigt namn</label>
                  <input type="text" id="name" name="name" required class="w-full border border-gray-300 rounded !px-2 !py-1">
                </div>
                <div>
                  <label for="street" class="block mb-2 font-semibold">Gatuadress</label>
                  <input type="text" id="street" name="street" required class="w-full border border-gray-300 rounded !px-2 !py-1">
                </div>
                <div>
                  <label for="zip" class="block mb-2 font-semibold">Postnummer</label>
                  <input type="text" id="zip" name="zip" required class="w-full border border-gray-300 rounded !px-2 !py-1">
                </div>
                <div>
                  <label for="city" class="block mb-2 font-semibold">Stad</label>
                  <input type="text" id="city" name="city" required class="w-full border border-gray-300 rounded !px-2 !py-1">
                </div>
              </form>
            </div>
            <div class="bg-surface p-6 !mb-4">
              <h2 class="text-2xl font-bold mb-4">Fraktalternativ</h2>
              <div class="space-y-3">
                <label class="flex items-start p-4 border-2 border-gray-300 cursor-pointer hover:border-accent transition-colors">
                  <input type="radio" name="shipping" value="postnord" checked class="!mt-1 !ml-1 !mr-2" id="shipping-postnord">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <img src="/images/postnord-icon.webp" alt="PostNord" class="w-8 h-8">
                      <div>
                        <div class="font-semibold">PostNord</div>
                        <div class="text-sm text-gray-600">3 - 4 vardagar</div>
                      </div>
                      <div class="ml-auto font-bold" id="shipping-price-label">${totals.qualifiesForFreeShipping ? '0 SEK' : `${shippingCost} SEK`}</div>
                    </div>
                    <p class="text-sm text-gray-600">Skickas till din brevl√•da/d√∂rr, eller till: N√§rmaste Servicest√§lle</p>
                  </div>
                </label>
              </div>
            </div>
          </div>
          <div>
            <div class="bg-surface p-6 sticky top-4">
              <h2 class="text-2xl font-bold mb-4">Ordersammanfattning</h2>
              <div class="!mb-4 !p-2 bg-blue-50 border border-blue-200 rounded-lg ${totals.qualifiesForFreeShipping ? 'hidden' : ''}" id="free-shipping-cta">
                <div class="flex items-center justify-between !mb-2">
                  <span class="text-sm font-semibold text-blue-800">Fri frakt vid k√∂p √∂ver ${freeShippingThreshold} SEK</span>
                  <span class="text-sm font-bold text-blue-800" id="remaining-free-shipping">${totals.remainingForFreeShipping.toFixed(0)} SEK kvar</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="free-shipping-progress" style="width: ${Math.min(100, ((totals.subtotal / freeShippingThreshold) * 100))}%"></div>
                </div>
              </div>
              <div class="!mb-4 bg-green-50 border border-green-200 rounded-lg ${totals.qualifiesForFreeShipping ? '' : 'hidden'}" id="free-shipping-success">
                <p class="text-sm font-semibold text-green-800">üéâ Du kvalificerar f√∂r fri frakt!</p>
              </div>
              ${upsellSection}
              <div class="space-y-2 mb-4">
                ${cart.map((item: any, index: number) => {
                  const productData = productDataArray[index];
                  const itemPrice = productData?.price ?? item.price;
                  return `
                  <div class="flex justify-between">
                    <span>${item.product_name} x${item.quantity}</span>
                      <span>${(itemPrice * item.quantity).toFixed(2)} SEK</span>
                    </div>
                  `;
                }).join('')}
                <div class="border-t pt-2 flex justify-between">
                  <span>Delsumma:</span>
                  <span id="summary-subtotal">${totals.subtotal.toFixed(2)} SEK</span>
                </div>
                <div class="flex justify-between ${totals.discountAmount > 0 ? '' : 'hidden'}" id="discount-row">
                  <span>Rabatt <span id="discount-code-label"></span></span>
                  <span id="discount-amount">- ${totals.discountAmount.toFixed(2)} SEK</span>
                </div>
                <div class="flex justify-between">
                  <span>Frakt:</span>
                  <span id="summary-shipping">${totals.qualifiesForFreeShipping ? 'Fri frakt' : `${shippingCost} SEK`}</span>
                  </div>
                <div class="border-t pt-2 flex justify-between font-bold text-xl">
                  <span>Totalt:</span>
                  <span id="summary-total">${totals.total.toFixed(2)} SEK</span>
                </div>
                ${totals.belowStripeMinimum ? `
                  <div class="mt-2 text-sm text-red-700 bg-red-50 border border-red-200 rounded p-2">
                    Stripe kr√§ver minst ${stripeMinimum} SEK f√∂r betalning. L√§gg till fler varor f√∂r att forts√§tta.
                  </div>
                ` : ''}
                <div class="!mt-2 !mb-4">
                  <button 
                    type="button"
                    id="toggle-discount"
                    class="text-sm font-semibold text-primary hover:text-accent flex items-center gap-2"
                  >
                    L√§gg till kod
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                  </button>
                  <div id="discount-form" class="hidden !mt-2 space-y-2">
                    <div class="flex gap-2">
                      <input id="discount-input" type="text" placeholder="Rabattkod" class="flex-1 border border-gray-300 rounded !px-2 !py-1" />
                      <button id="apply-discount" type="button" class="bg-primary bg-indigo-950 text-white !px-3 !py-1 rounded hover:opacity-90 transition">Anv√§nd</button>
                    </div>
                    <p id="discount-message" class="text-sm text-red-600 hidden"></p>
                  </div>
                </div>
              </div>
              <button 
                id="checkout-button"
                class="w-full bg-indigo-950 hover:bg-indigo-900 text-white rounded-lg font-semibold shadow-lg transition-all text-lg !mb-5"
                style="padding: 0.875rem 2rem !important;"
              >
                Forts√§tt till betalning
              </button>
            </div>
          </div>
        </div>
      `;

      // Handle checkout
      const discountRow = document.getElementById('discount-row');
      const discountAmountEl = document.getElementById('discount-amount');
      const discountCodeLabel = document.getElementById('discount-code-label');
      const shippingLabel = document.getElementById('summary-shipping');
      const subtotalEl = document.getElementById('summary-subtotal');
      const totalEl = document.getElementById('summary-total');
      const remainingFreeShippingEl = document.getElementById('remaining-free-shipping');
      const freeShippingProgress = document.getElementById('free-shipping-progress') as HTMLElement | null;
      const toggleDiscountBtn = document.getElementById('toggle-discount');
      const discountForm = document.getElementById('discount-form');
      const applyDiscountBtn = document.getElementById('apply-discount');
      const discountInput = document.getElementById('discount-input') as HTMLInputElement | null;
      const discountMessage = document.getElementById('discount-message');
      const shippingPriceLabel = document.getElementById('shipping-price-label');
      const freeShippingCta = document.getElementById('free-shipping-cta');
      const freeShippingSuccess = document.getElementById('free-shipping-success');
      const upsellWrapper = document.getElementById('upsell-wrapper');
      const upsellRemainingLabel = upsellWrapper?.querySelector('[data-remaining-label]');
      const upsellButtons = container.querySelectorAll('.js-add-upsell');

      function addUpsellToCart(productId: string, name: string, price: number) {
        const existingIndex = cart.findIndex((item: any) => item.product_id === productId);
        if (existingIndex !== -1) {
          cart[existingIndex].quantity += 1;
        } else {
          cart.push({ product_id: productId, product_name: name, quantity: 1, price });
        }
        localStorage.setItem('feedzone-cart', JSON.stringify(cart));
        renderCheckout();
      }

      function refreshSummary() {
        if (!container) return;
        const next = calcTotals();
        if (subtotalEl) subtotalEl.textContent = `${next.subtotal.toFixed(2)} SEK`;
        if (shippingLabel) shippingLabel.textContent = next.qualifiesForFreeShipping ? 'Fri frakt' : `${shippingCost} SEK`;
        if (totalEl) totalEl.textContent = `${next.total.toFixed(2)} SEK`;
        if (remainingFreeShippingEl) remainingFreeShippingEl.textContent = `${next.remainingForFreeShipping.toFixed(0)} SEK kvar`;
        if (freeShippingProgress) {
          freeShippingProgress.style.width = `${Math.min(100, ((next.subtotal / freeShippingThreshold) * 100))}%`;
        }
        if (freeShippingCta && freeShippingSuccess) {
          if (next.qualifiesForFreeShipping) {
            freeShippingCta.classList.add('hidden');
            freeShippingSuccess.classList.remove('hidden');
          } else {
            freeShippingCta.classList.remove('hidden');
            freeShippingSuccess.classList.add('hidden');
          }
        }
        if (upsellWrapper) {
          if (next.qualifiesForFreeShipping) {
            upsellWrapper.classList.add('hidden');
          } else {
            upsellWrapper.classList.remove('hidden');
            if (upsellRemainingLabel) {
              upsellRemainingLabel.textContent = `${next.remainingForFreeShipping.toFixed(0)} SEK kvar`;
            }
          }
        }
        if (discountRow && discountAmountEl && discountCodeLabel) {
          if (next.discountAmount > 0 && discount) {
            discountRow.classList.remove('hidden');
            discountAmountEl.textContent = `- ${next.discountAmount.toFixed(2)} SEK`;
            discountCodeLabel.textContent = `(${discount?.code ?? ''})`;
          } else {
            discountRow.classList.add('hidden');
          }
        }
        const stripeNotice = container.querySelector('.text-red-700.bg-red-50');
        if (stripeNotice) {
          if (next.belowStripeMinimum) {
            stripeNotice.classList.remove('hidden');
          } else {
            stripeNotice.classList.add('hidden');
          }
        }
        if (shippingPriceLabel) {
          shippingPriceLabel.textContent = next.qualifiesForFreeShipping ? '0 SEK' : `${shippingCost} SEK`;
        }
        const checkoutButton = document.getElementById('checkout-button') as HTMLButtonElement | null;
        if (checkoutButton) {
          checkoutButton.disabled = next.belowStripeMinimum;
        }
      }

      upsellButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const { upsellId, upsellName, upsellPrice } = (btn as HTMLElement).dataset;
          if (!upsellId || !upsellName || !upsellPrice) return;
          const parsedPrice = parseFloat(upsellPrice);
          addUpsellToCart(upsellId, upsellName, Number.isFinite(parsedPrice) ? parsedPrice : 0);
        });
      });

      toggleDiscountBtn?.addEventListener('click', () => {
        discountForm?.classList.toggle('hidden');
        discountMessage?.classList.add('hidden');
      });

      applyDiscountBtn?.addEventListener('click', async () => {
        const code = discountInput?.value.trim() || '';
        if (!code) {
          if (discountMessage) {
            discountMessage.textContent = 'Ange en kod';
            discountMessage.classList.remove('hidden');
            discountMessage.classList.remove('text-green-700');
            discountMessage.classList.add('text-red-600');
          }
          return;
        }
        try {
          const res = await fetch(`/api/discount-code?code=${encodeURIComponent(code)}`);
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || 'Ogiltig kod');
          }
          discount = data;
          if (discountMessage) {
            discountMessage.textContent = `Koden ${discount?.code ?? ''} √§r aktiverad.`;
            discountMessage.classList.remove('hidden');
            discountMessage.classList.remove('text-red-600');
            discountMessage.classList.add('text-green-700');
          }
          refreshSummary();
        } catch (err: any) {
          if (discountMessage) {
            discountMessage.textContent = err.message || 'Ogiltig kod';
            discountMessage.classList.remove('hidden');
            discountMessage.classList.remove('text-green-700');
            discountMessage.classList.add('text-red-600');
          }
        }
      });

      document.getElementById('checkout-button')?.addEventListener('click', async () => {
        const totalsNow = calcTotals();
        if (totalsNow.belowStripeMinimum) {
          alert(`Stripe kr√§ver minst ${stripeMinimum} SEK f√∂r betalning. L√§gg till fler varor f√∂r att forts√§tta.`);
          return;
        }
        const form = document.getElementById('shipping-form') as HTMLFormElement;
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const formData = new FormData(form);
        const shippingMethod = (document.querySelector('input[name="shipping"]:checked') as HTMLInputElement)?.value || 'postnord';
        const shippingAddress = {
          email: formData.get('email'),
          name: formData.get('name'),
          street: formData.get('street'),
          city: formData.get('city'),
          zip: formData.get('zip'),
        };

        const checkoutButton = document.getElementById('checkout-button') as HTMLButtonElement;
        checkoutButton.disabled = true;
        checkoutButton.textContent = 'Bearbetar...';

        try {
          const response = await fetch('/api/stripe/create-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              items: cart,
              shipping_address: shippingAddress,
              shipping_method: shippingMethod,
              discount_code: discount?.code,
            }),
          });

          const data = await response.json();

          if (data.url) {
            window.location.href = data.url;
          } else {
            throw new Error(data.error || 'Failed to create checkout session');
          }
        } catch (error: any) {
          alert('Fel: ' + error.message);
          checkoutButton.disabled = false;
          checkoutButton.textContent = 'Forts√§tt till betalning';
        }
      });
    }

    renderCheckout();
  }
</script>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
</style>


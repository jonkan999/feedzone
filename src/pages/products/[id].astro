--- 
// @ts-nocheck
import Layout from '../../layouts/Layout.astro';
import { createServerClient } from '../../lib/supabase';

export const prerender = false;

const selectionLabelFallback = (variantType?: string | null) => {
  if (!variantType) return null;
  if (variantType === 'flavor') return 'Välj smak';
  if (variantType === 'size') return 'Välj storlek';
  if (variantType === 'quantity') return 'Välj mängd';
  return 'Välj alternativ';
};

const { id } = Astro.params;

let product: any = null;
if (id) {
  try {
    const supabase: any = createServerClient();
    const { data } = await supabase
      .from('products')
      .select('*, product_groups(selection_label,name)')
      .eq('id', id)
      .single();

    if (data) {
      let siblings: any[] = [];
      if (data.group_id) {
        const { data: sibData } = await supabase
          .from('products')
          .select('id,name,price,image_url,variant_value,variant_type,variant_sort')
          .eq('group_id', data.group_id)
          .order('variant_sort', { ascending: true, nullsFirst: true });
        siblings = sibData || [];
      }

      product = {
        ...data,
        selection_label: data.product_groups?.selection_label || selectionLabelFallback(data.variant_type),
        siblings,
      };
    }
  } catch (error) {
    // Will handle in client-side fallback
  }
}
---

<Layout title={product ? `${product.name} - Feed Zone` : 'Product - Feed Zone'}>
<div class="container mx-auto px-4" style="padding-top: 4rem; padding-bottom: 4rem;">
  {product ? (
    <>
      <script type="application/json" id="product-json">{JSON.stringify(product)}</script>
      <div class="space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Product Images -->
          <div>
            <div id="main-image-container" class="mb-4">
              <img 
                id="main-product-image"
                src={product.image_url || '/images/placeholder.jpg'} 
                alt={product.name}
                class="w-full rounded-lg cursor-pointer"
              />
            </div>
            {(product.additional_images && Array.isArray(product.additional_images) && product.additional_images.length > 0) || product.image_url ? (
              <div id="thumbnails-container" class="grid grid-cols-4 gap-2">
                <img 
                  src={product.image_url || '/images/placeholder.jpg'} 
                  alt={product.name}
                  class="w-full h-20 object-cover rounded border-2 border-primary cursor-pointer hover:opacity-75 transition-opacity thumbnail-image"
                  data-image-url={product.image_url || '/images/placeholder.jpg'}
                />
                {product.additional_images && Array.isArray(product.additional_images) && product.additional_images.map((imgUrl, index) => (
                  <img 
                    src={imgUrl} 
                    alt={`${product.name} - Bild ${index + 2}`}
                    class="w-full h-20 object-cover rounded border-2 border-transparent cursor-pointer hover:opacity-75 transition-opacity thumbnail-image"
                    data-image-url={imgUrl}
                  />
                ))}
              </div>
            ) : null}
          </div>
          
          <!-- Product Info -->
          <div>
          <h1 id="product-title" class="text-4xl font-bold text-primary" style="margin-bottom: 1rem;">{product.name}</h1>
          <p id="product-price" class="text-2xl font-bold text-accent" style="margin-bottom: 1rem;">{product.price.toFixed(2)} SEK</p>
          <div id="product-description" class="text-text-muted product-description" style="margin-bottom: 1.5rem;" set:html={product.description || 'Ingen beskrivning tillgänglig.'}></div>
            
            {product.in_stock ? (
              <div>
                {product.siblings && product.siblings.length > 0 ? (
                  <div class="!mb-4">
                    <label for="variant-select" class="block mb-2 font-semibold">{product.selection_label || 'Välj alternativ'}:</label>
                    <select 
                      id="variant-select" 
                      class="w-full border border-gray-300 rounded !px-2 !py-1 mb-2"
                      value={product.id}
                    >
                      {product.siblings.map((sib) => (
                        <option value={sib.id}>{sib.variant_value || sib.name}</option>
                      ))}
                    </select>
                  </div>
                ) : null}
                
                <div 
                  class="quantity-controls w-full flex justify-center" 
                  data-product-id={product.id} 
                  data-product-name={product.name} 
                  data-product-price={product.price}
                  data-variant-value={product.variant_value || ''}
                  data-selection-label={product.selection_label || ''}
                >
                  <div id="quantity-controls-container" class="w-full flex justify-center">
                    <button class="kop-btn bg-indigo-950 text-white px-8 h-10 rounded font-semibold hover:bg-indigo-900 transition-all uppercase text-sm cursor-pointer" style="min-width: 300px;">KÖP</button>
                  </div>
                </div>
              </div>
            ) : (
              <p class="text-red-600 font-semibold">Slut i lager</p>
            )}
          </div>
        </div>

        {product.siblings && product.siblings.length > 0 ? (
          <div class="mt-8">
            <h2 class="text-lg font-semibold mb-3" id="sibling-title">{product.selection_label || 'Se fler varianter'}</h2>
            <div class="flex gap-3 overflow-x-auto pb-2 sibling-scroller" id="sibling-scroller">
              {product.siblings.map((sib) => (
                <a 
                  href={`/products/${sib.id}`} 
                  data-variant-id={sib.id}
                  class={`relative flex-shrink-0 w-32 border rounded-lg overflow-hidden hover:border-primary transition ${sib.id === product.id ? 'border-primary' : 'border-gray-200'}`}
                >
                  <img 
                    src={sib.image_url || product.image_url || '/images/placeholder.jpg'} 
                    alt={sib.name} 
                    class="w-full h-24 object-cover"
                  />
                  <div class="absolute top-2 left-2 bg-white/90 text-xs font-semibold px-2 py-1 rounded shadow">{sib.price?.toFixed(2)} SEK</div>
                  <div class="text-xs font-semibold text-center px-2 py-2 line-clamp-2">{sib.variant_value || sib.name}</div>
                </a>
              ))}
            </div>
          </div>
        ) : null}
      </div>
    </>
    ) : (
      <div id="product-container">
        <p class="text-text-muted">Laddar produkt...</p>
      </div>
    )}
  </div>
</Layout>

<script>
  // @ts-nocheck
  if (typeof window !== 'undefined') {
    const productJson = document.getElementById('product-json');
    let currentProduct = null;
    if (productJson) {
      try {
        currentProduct = JSON.parse(productJson.textContent || 'null');
      } catch (e) {
        currentProduct = null;
      }
    }

    const mainImage = document.getElementById('main-product-image');
    const thumbnailsContainer = document.getElementById('thumbnails-container');
    const titleEl = document.getElementById('product-title');
    const priceEl = document.getElementById('product-price');
    const descEl = document.getElementById('product-description');
    const variantSelect = document.getElementById('variant-select');
    const siblingScroller = document.getElementById('sibling-scroller');
    const siblingTitle = document.getElementById('sibling-title');

    function attachThumbnailListeners() {
      const thumbs = document.querySelectorAll('.thumbnail-image');
      thumbs.forEach((thumb) => {
        thumb.addEventListener('click', () => {
          const imageUrl = thumb.getAttribute('data-image-url');
          if (mainImage && imageUrl) {
            mainImage.src = imageUrl;
            thumbs.forEach((t) => {
              t.classList.remove('border-primary');
              t.classList.add('border-transparent');
            });
            thumb.classList.remove('border-transparent');
            thumb.classList.add('border-primary');
          }
        });
      });
    }

    function renderImages(prod) {
      if (mainImage) {
        mainImage.src = prod.image_url || '/images/placeholder.jpg';
        mainImage.alt = prod.name || '';
      }
      if (thumbnailsContainer) {
        const primary = prod.image_url || '/images/placeholder.jpg';
        const additional = Array.isArray(prod.additional_images) ? prod.additional_images : [];
        thumbnailsContainer.innerHTML = `
          <img src="${primary}" alt="${prod.name}" class="w-full h-20 object-cover rounded border-2 border-primary cursor-pointer hover:opacity-75 transition-opacity thumbnail-image" data-image-url="${primary}">
          ${additional.map((imgUrl, index) => `
            <img src="${imgUrl}" alt="${prod.name} - Bild ${index + 2}" class="w-full h-20 object-cover rounded border-2 border-transparent cursor-pointer hover:opacity-75 transition-opacity thumbnail-image" data-image-url="${imgUrl}">
          `).join('')}
        `;
        attachThumbnailListeners();
      }
    }

    function renderVariantSelect(prod) {
      if (!variantSelect) return;
      const siblings = Array.isArray(prod.siblings) ? prod.siblings : [];
      if (!siblings.length) return;
      variantSelect.innerHTML = siblings.map((sib) => `
        <option value="${sib.id}" ${sib.id === prod.id ? 'selected' : ''}>${sib.variant_value || sib.name}</option>
      `).join('');
      variantSelect.value = prod.id;
    }

    function renderSiblings(prod) {
      if (!siblingScroller) return;
      const siblings = Array.isArray(prod.siblings) ? prod.siblings : [];
      if (siblingTitle) {
        siblingTitle.textContent = prod.selection_label || 'Se fler varianter';
      }
      siblingScroller.innerHTML = siblings.map((sib) => `
        <a href="/products/${sib.id}" data-variant-id="${sib.id}" class="relative flex-shrink-0 w-32 border rounded-lg overflow-hidden hover:border-primary transition ${sib.id === prod.id ? 'border-primary' : 'border-gray-200'}">
          <img src="${sib.image_url || prod.image_url || '/images/placeholder.jpg'}" alt="${sib.name}" class="w-full h-24 object-cover" />
          <div class="absolute top-2 left-2 bg-white/90 text-xs font-semibold px-2 py-1 rounded shadow">${(sib.price ?? 0).toFixed(2)} SEK</div>
          <div class="text-xs font-semibold text-center px-2 py-2 line-clamp-2">${sib.variant_value || sib.name}</div>
        </a>
      `).join('');
    }

    function renderBasics(prod) {
      if (titleEl) titleEl.textContent = prod.name || '';
      if (priceEl) priceEl.textContent = `${(prod.price ?? 0).toFixed(2)} SEK`;
      if (descEl) descEl.innerHTML = prod.description || 'Ingen beskrivning tillgänglig.';
    }

    function applyProduct(prod) {
      currentProduct = prod;
      renderBasics(prod);
      renderImages(prod);
      renderVariantSelect(prod);
      renderSiblings(prod);

      const controlsDiv = document.querySelector('.quantity-controls');
      if (controlsDiv) {
        controlsDiv.setAttribute('data-product-id', prod.id);
        controlsDiv.setAttribute('data-product-name', prod.name || '');
        controlsDiv.setAttribute('data-product-price', String(prod.price ?? 0));
        controlsDiv.setAttribute('data-variant-value', prod.variant_value || '');
        controlsDiv.setAttribute('data-selection-label', prod.selection_label || '');
      }
      updateQuantityControls();
      setupQuantityListeners();
    }

    async function loadVariant(productId) {
      if (!productId || currentProduct?.id === productId) return;
      try {
        const res = await fetch(`/api/products/${productId}`);
        const data = await res.json();
        if (!data?.error) {
          applyProduct(data);
        }
      } catch (e) {
        console.error('Failed to load variant', e);
      }
    }

    if (variantSelect) {
      variantSelect.addEventListener('change', (e) => {
        e.stopPropagation();
        const selectedId = e.target.value;
        loadVariant(selectedId);
      });
    }

    if (siblingScroller) {
      siblingScroller.addEventListener('click', (e) => {
        const link = e.target.closest('a[data-variant-id]');
        if (!link) return;
        e.preventDefault();
        const vid = link.getAttribute('data-variant-id');
        loadVariant(vid);
      });
    }

    // Function to update quantity controls display
    function updateQuantityControls() {
      const controlsDiv = document.querySelector('.quantity-controls');
      if (!controlsDiv) return;
      
      const productId = controlsDiv.getAttribute('data-product-id');
      const productName = controlsDiv.getAttribute('data-product-name');
      const productPrice = controlsDiv.getAttribute('data-product-price');
      const container = document.getElementById('quantity-controls-container');
      
      if (!container || !productId) return;
      
      const cart = JSON.parse(localStorage.getItem('feedzone-cart') || '[]');
      const cartItem = cart.find((item: any) => item.product_id === productId);
      const initialQuantity = cartItem ? cartItem.quantity : 0;
      const isInCart = initialQuantity > 0;
      
      if (isInCart) {
        container.innerHTML = `
          <div class="flex items-center gap-2 quantity-buttons justify-center">
            <button class="quantity-btn minus bg-gray-200 hover:bg-gray-300 text-gray-700 w-10 h-10 rounded flex items-center justify-center font-semibold transition-colors text-lg cursor-pointer" data-action="decrease">−</button>
            <input type="number" class="quantity-input w-14 h-10 text-center border border-gray-300 rounded font-semibold text-base" value="${initialQuantity}" min="0" data-product-id="${productId}">
            <button class="quantity-btn plus bg-gray-200 hover:bg-gray-300 text-gray-700 w-10 h-10 rounded flex items-center justify-center font-semibold transition-colors text-lg cursor-pointer" data-action="increase">+</button>
          </div>
        `;
      } else {
        container.innerHTML = `<button class="kop-btn bg-indigo-950 text-white px-8 h-10 rounded font-semibold hover:bg-indigo-900 transition-all uppercase text-sm cursor-pointer" style="min-width: 300px;">KÖP</button>`;
      }
    }

    // Update quantity controls on page load
    updateQuantityControls();
    
    // Listen for cart updates
    window.addEventListener('cart-updated', () => {
      updateQuantityControls();
      setupQuantityListeners();
    });

    // Function to update cart quantity
    function updateCartQuantity(productId, quantity) {
      const cart = JSON.parse(localStorage.getItem('feedzone-cart') || '[]');
      const itemIndex = cart.findIndex((item) => item.product_id === productId);
      
      if (itemIndex >= 0) {
        if (quantity <= 0) {
          cart.splice(itemIndex, 1);
        } else {
          cart[itemIndex].quantity = quantity;
        }
        localStorage.setItem('feedzone-cart', JSON.stringify(cart));
        window.dispatchEvent(new Event('cart-updated'));
      }
    }

    // Setup quantity control listeners
    function setupQuantityListeners() {
      const controlsDiv = document.querySelector('.quantity-controls');
      if (!controlsDiv) return;
      
      const productId = controlsDiv.getAttribute('data-product-id');
      const productName = controlsDiv.getAttribute('data-product-name');
      const productPrice = parseFloat(controlsDiv.getAttribute('data-product-price') || '0');
      const selectionLabel = controlsDiv.getAttribute('data-selection-label') || '';
      const variantValue = controlsDiv.getAttribute('data-variant-value') || '';
      
      // Handle KÖP button
      const kopBtn = controlsDiv.querySelector('.kop-btn');
      if (kopBtn) {
        kopBtn.addEventListener('click', () => {
          const cart = JSON.parse(localStorage.getItem('feedzone-cart') || '[]');
          cart.push({
            product_id: productId,
            product_name: productName,
            price: productPrice,
            quantity: 1,
            selection_label: selectionLabel,
            variant_value: variantValue,
          });
          localStorage.setItem('feedzone-cart', JSON.stringify(cart));
          window.dispatchEvent(new Event('cart-updated'));
        }, { once: true });
      }
      
      // Handle quantity buttons
      const quantityBtns = controlsDiv.querySelectorAll('.quantity-btn');
      quantityBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          const action = btn.getAttribute('data-action');
          const input = controlsDiv.querySelector('.quantity-input');
          if (!input) return;
          
          let quantity = parseInt(input.value) || 0;
          if (action === 'increase') {
            quantity += 1;
          } else if (action === 'decrease' && quantity > 0) {
            quantity -= 1;
          }
          input.value = quantity.toString();
          if (productId) {
            updateCartQuantity(productId, quantity);
          }
        });
      });
      
      // Handle quantity input changes
      const quantityInput = controlsDiv.querySelector('.quantity-input');
      if (quantityInput) {
        quantityInput.addEventListener('change', () => {
          const input = quantityInput;
          const quantity = parseInt(input.value) || 0;
          if (productId) {
            updateCartQuantity(productId, Math.max(0, quantity));
          }
        });
      }
    }

    // Initial setup
    if (currentProduct) {
      applyProduct(currentProduct);
    } else {
      attachThumbnailListeners();
      setupQuantityListeners();
    }

    // Load product if not server-rendered
    const productContainer = document.getElementById('product-container');
    if (productContainer) {
      const productId = window.location.pathname.split('/').pop();
      fetch(`/api/products/${productId}`)
        .then(res => res.json())
        .then(product => {
          if (product.error) {
            productContainer.innerHTML = '<p class="text-red-500">Produkt hittades inte.</p>';
          } else {
            const additionalImages = product.additional_images && Array.isArray(product.additional_images) ? product.additional_images : [];
            const siblings = Array.isArray(product.siblings) ? product.siblings : [];
            const variantOptions = siblings.length
              ? siblings.map((sib) => 
                  `<option value="${sib.id}" ${sib.id === product.id ? 'selected' : ''}>${sib.variant_value || sib.name}</option>`
                ).join('')
              : '';
            
            productContainer.innerHTML = `
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <div id="main-image-container" class="mb-4">
                    <img id="main-product-image" src="${product.image_url || '/images/placeholder.jpg'}" alt="${product.name}" class="w-full rounded-lg cursor-pointer">
                  </div>
                  ${additionalImages.length > 0 ? `
                    <div id="thumbnails-container" class="grid grid-cols-4 gap-2">
                      <img src="${product.image_url || '/images/placeholder.jpg'}" alt="${product.name}" class="w-full h-20 object-cover rounded border-2 border-primary cursor-pointer hover:opacity-75 transition-opacity thumbnail-image" data-image-url="${product.image_url || '/images/placeholder.jpg'}">
                      ${additionalImages.map((imgUrl, index) => 
                        `<img src="${imgUrl}" alt="${product.name} - Bild ${index + 2}" class="w-full h-20 object-cover rounded border-2 border-transparent cursor-pointer hover:opacity-75 transition-opacity thumbnail-image" data-image-url="${imgUrl}">`
                      ).join('')}
                    </div>
                  ` : ''}
                </div>
                <div>
                  <h1 id="product-title" class="text-4xl font-bold text-primary" style="margin-bottom: 1rem;">${product.name}</h1>
                  <p id="product-price" class="text-2xl font-bold text-accent" style="margin-bottom: 1rem;">${product.price.toFixed(2)} SEK</p>
                  <div id="product-description" class="text-text-muted product-description" style="margin-bottom: 1.5rem;">${product.description || 'Ingen beskrivning tillgänglig.'}</div>
                  ${product.in_stock ? `
                    <div>
                      ${siblings.length ? `
                        <div class="!mb-4">
                          <label for="variant-select" class="block mb-2 font-semibold">${product.selection_label || 'Välj alternativ'}:</label>
                          <select id="variant-select" class="w-full border border-gray-300 rounded !px-2 !py-1 mb-2">
                            ${variantOptions}
                          </select>
                        </div>
                      ` : ''}
                      <div class="quantity-controls w-full flex justify-center" data-product-id="${product.id}" data-product-name="${product.name}" data-product-price="${product.price}" data-variant-value="${product.variant_value || ''}" data-selection-label="${product.selection_label || ''}">
                        <div id="quantity-controls-container" class="w-full flex justify-center">
                          <button class="kop-btn bg-indigo-950 text-white px-8 h-10 rounded font-semibold hover:bg-indigo-900 transition-all uppercase text-sm cursor-pointer" style="min-width: 300px;">KÖP</button>
                        </div>
                      </div>
                    </div>
                  ` : '<p class="text-red-600 font-semibold">Slut i lager</p>'}
                </div>
              </div>
              ${siblings.length ? `
                <div class="mt-8">
                  <h2 class="text-lg font-semibold mb-3" id="sibling-title">${product.selection_label || 'Se fler varianter'}</h2>
                  <div class="flex gap-3 overflow-x-auto pb-2 sibling-scroller" id="sibling-scroller">
                    ${siblings.map((sib) => `
                      <a href="/products/${sib.id}" data-variant-id="${sib.id}" class="relative flex-shrink-0 w-32 border rounded-lg overflow-hidden hover:border-primary transition ${sib.id === product.id ? 'border-primary' : 'border-gray-200'}">
                        <img src="${sib.image_url || product.image_url || '/images/placeholder.jpg'}" alt="${sib.name}" class="w-full h-24 object-cover" />
                        <div class="absolute top-2 left-2 bg-white/90 text-xs font-semibold px-2 py-1 rounded shadow">${(sib.price ?? 0).toFixed(2)} SEK</div>
                        <div class="text-xs font-semibold text-center px-2 py-2 line-clamp-2">${sib.variant_value || sib.name}</div>
                      </a>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            `;
            
            currentProduct = product;
            applyProduct(product);
          }
        })
        .catch(error => {
          productContainer.innerHTML = '<p class="text-red-500">Fel vid laddning av produkt.</p>';
        });
    }
  }
</script>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .quantity-input {
    -moz-appearance: textfield;
  }
  
  .quantity-input::-webkit-outer-spin-button,
  .quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  
  #quantity-controls-container {
    width: 100%;
    display: flex;
    justify-content: center;
  }
  
  .kop-btn {
    min-width: 300px !important;
  }

  /* Product description styling for HTML content */
  :global(.product-description) {
    line-height: 1.6;
  }

  :global(.product-description strong) {
    font-weight: 600;
    color: #0f172a;
  }

  :global(.product-description a) {
    color: #7fc4c3;
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s ease;
  }

  :global(.product-description a:hover) {
    color: #5fa5a4;
  }
</style>


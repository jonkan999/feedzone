
<nav class="nav-shell fixed top-0 inset-x-0 z-50 bg-white border-b-2 border-gray-200 shadow-sm px-4 md:px-8 lg:px-12">
  <div class="container mx-auto px-6 md:px-12">
    <div class="grid grid-cols-3 items-center h-20 md:hidden gap-3">
      <div class="flex items-center gap-2">
        <button
          id="menu-toggle"
          class="menu-toggle-btn p-3 text-primary hover:text-primary transition-colors"
          aria-label="Öppna navigation"
          aria-expanded="false"
        >
          <svg class="menu-toggle-icon w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <div id="auth-buttons-mobile" class="flex items-center"></div>
      </div>

      <a href="/" class="flex justify-center -translate-x-13 hover:opacity-80 transition-opacity">
        <div class="flex items-center gap-2">
          <img src="/images/logo-icon.png" alt="Feed Zone Icon" class="h-9 w-auto" />
          <img src="/images/logo-text.png" alt="Feed Zone" class="h-11 w-auto -translate-y-0.5" />
        </div>
      </a>

      <div class="flex justify-end !mt-0.5">
        <a
          href="/cart"
          class="mobile-cart-btn relative inline-flex items-center gap-1 text-white px-3 py-2 w-full rounded-lg !p-1 shadow-md overflow-hidden"
          style="background: linear-gradient(130deg, color-mix(in srgb, var(--color-accent-secondary) 88%, white 12%), color-mix(in srgb, var(--color-accent-secondary) 70%, black 30%));"
        >
          <span class="flex items-center gap-0.5 text-white">
            <span class="flex items-center justify-center rounded-md p-1.5">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5.5 10h13l-1.3 8h-10.4z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 10 10.5 6h3L16 10" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 14h6" />
              </svg>
            </span>
            <span class="text-xs font-semibold uppercase leading-tight">Varukorg</span>
          </span>
          <span
            data-cart-count
            class="cart-count-badge absolute inset-y-0 right-0 flex items-center justify-center px-3 text-xs font-bold leading-none text-white !p-2.5"
            style="background: color-mix(in srgb, var(--color-accent-secondary) 70%, black 30%);"
          >
            0
          </span>
        </a>
      </div>
    </div>

    <div class="hidden md:flex items-center justify-between h-28">
      <div class="flex items-center gap-3 md:gap-4">
        <a href="/" class="flex items-center gap-2 md:gap-3 hover:opacity-80 transition-opacity">
          <div class="flex flex-row md:flex-row items-center gap-1 md:gap-2">
            <img src="/images/logo-text.png" alt="Feed Zone" class="h-[3.5rem] md:h-11 w-auto order-2 md:order-1" />
            <img src="/images/logo-icon.png" alt="Feed Zone Icon" class="h-12 md:h-11 w-auto order-1 md:order-2" />
          </div>
        </a>
      </div>

      <div class="hidden md:flex items-center gap-6">
        <div class="relative group">
          <button class="text-sm font-semibold text-gray-700 hover:text-primary transition-colors flex items-center gap-1 uppercase tracking-wide">
            Handla
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="absolute top-full left-0 !mt-1 bg-white border border-gray-200 !py-1 min-w-[200px] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50">
            <a href="/products?category=carbs" class="block !px-2 !py-1 hover:bg-gray-50 text-sm font-medium text-gray-700">Carbs</a>
            <a href="/products?category=recovery" class="block !px-2 !py-1  hover:bg-gray-50 text-sm font-medium text-gray-700">Återhämtning</a>
            <a href="/products?category=pre-workout" class="block !px-2 !py-1  hover:bg-gray-50 text-sm font-medium text-gray-700">Pre-Workout</a>
            <a href="/products?category=gear" class="block !px-2 !py-1  hover:bg-gray-50 text-sm font-medium text-gray-700">Utrustning</a>
          </div>
        </div>

        <a href="/brands" class="text-sm font-semibold text-gray-700 hover:text-primary transition-colors uppercase tracking-wide">Brands</a>
        <a href="/zone-news" class="text-sm font-semibold text-gray-700 hover:text-primary transition-colors uppercase tracking-wide">In the Zone</a>
      </div>

      <div class="flex items-center gap-4 md:gap-6">
        <div id="auth-buttons-desktop" class="hidden md:flex gap-4"></div>

        <a href="/cart" class="text-gray-700 hover:text-primary transition-colors relative p-2 hidden md:inline-flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5.5 10h13l-1.3 8h-10.4z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 10 10.5 6h3L16 10" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 14h6" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.5 16.5h5" />
          </svg>
          <span data-cart-count class="cart-count-badge hidden absolute -top-2 -right-2 text-gray-900 text-xs font-bold bg-white rounded-full px-1.5 py-0.5">0</span>
        </a>
      </div>
    </div>

    <div id="mobile-menu-overlay" class="fixed inset-0 z-[999] bg-black/60 backdrop-blur-sm hidden md:hidden">
      <div id="mobile-menu-panel" class="mobile-menu-panel relative h-full w-[82%] max-w-sm bg-white shadow-2xl border-r border-gray-100 transform -translate-x-full transition-transform duration-300 rounded-r-2xl overflow-y-auto">
        <div class="flex items-center justify-between px-5 py-5 border-b border-gray-200">
          <span class="text-xl font-semibold text-gray-900 tracking-tight">Meny</span>
          <button id="menu-close" class="p-2 text-gray-700 hover:text-primary transition-colors" aria-label="Stäng meny">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 6l12 12M6 18L18 6"></path>
            </svg>
          </button>
        </div>
        <div class="!py-4 !space-y-2">
          <details class="group">
            <summary class="flex items-center justify-between px-5 py-4 text-base sm:text-lg font-semibold text-gray-900 hover:text-primary cursor-pointer">
              <span>Handla</span>
              <svg class="w-5 h-5 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </summary>
            <div class="!pl-6 !pb-3 !space-y-1 !mt-2">
              <a href="/products?category=carbs" class="subcategory block px-3 py-2 text-base font-medium text-gray-800 rounded-lg hover:bg-gray-50 hover:text-primary !mb-2">Carbs</a>
              <a href="/products?category=recovery" class="subcategory block px-3 py-2 text-base font-medium text-gray-800 rounded-lg hover:bg-gray-50 hover:text-primary !mb-2">Återhämtning</a>
              <a href="/products?category=pre-workout" class="subcategory block px-3 py-2 text-base font-medium text-gray-800 rounded-lg hover:bg-gray-50 hover:text-primary !mb-2">Pre-Workout</a>
              <a href="/products?category=gear" class="subcategory block px-3 py-2 text-base font-medium text-gray-800 rounded-lg hover:bg-gray-50 hover:text-primary !mb-2">Utrustning</a>
            </div>
          </details>
          <a href="/brands" class="block px-5 py-4 text-base sm:text-lg font-semibold text-gray-900 rounded-lg hover:bg-gray-50 hover:text-primary">Brands</a>
          <a href="/zone-news" class="block px-5 py-4 text-base sm:text-lg font-semibold text-gray-900 rounded-lg hover:bg-gray-50 hover:text-primary">In the Zone</a>
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="h-20 md:h-28"></div>

<script>
  import { supabase } from '../lib/supabase-client';
  
  if (typeof window !== 'undefined') {
    const cartCountEls = Array.from(document.querySelectorAll('[data-cart-count]')) as HTMLElement[];
    const authContainerIds = ['auth-buttons-desktop', 'auth-buttons-mobile'];
    const mobileCartBtn = document.querySelector('.mobile-cart-btn') as HTMLElement | null;
    const mobileCartOriginalBg = mobileCartBtn?.getAttribute('style')?.match(/background:([^;]+)/)?.[1]?.trim() || '';
    const mobileCartFlashBg = 'color-mix(in srgb, var(--color-accent-secondary) 65%, white 35%)';
    const mobileOverlay = document.getElementById('mobile-menu-overlay');
    const mobilePanel = document.getElementById('mobile-menu-panel');
    const menuToggle = document.getElementById('menu-toggle');
    const menuClose = document.getElementById('menu-close');
    let previousCartCount: number | null = null;

    const loginIconMobile = `
      <a href="/account/login" class="p-2 text-gray-800 hover:text-primary transition-colors" aria-label="Login">
        <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="8.5" r="3.25" />
          <path d="M5 19c1.35-2.5 4-3.9 7-3.9s5.65 1.4 7 3.9" />
        </svg>
      </a>
    `;

    const loginIconDesktop = `
      <a href="/account/login" class="p-2 text-gray-700 hover:text-primary transition-colors" aria-label="Login">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="8.5" r="3.25" />
          <path d="M5 19c1.35-2.5 4-3.9 7-3.9s5.65 1.4 7 3.9" />
        </svg>
      </a>
    `;

    const userMenuTemplate = (variant: 'mobile' | 'desktop') => {
      const sizeClasses = variant === 'mobile' ? 'w-7 h-7' : 'w-6 h-6';
      const paddingClasses = 'p-2';

      return `
        <div class="relative">
          <button
            type="button"
            class="user-menu-toggle ${paddingClasses} rounded-full text-accent-secondary hover:text-accent-secondary focus:outline-none leading-none flex items-center justify-center transition-colors"
            style="color: var(--color-accent-secondary);"
            aria-expanded="false"
            aria-haspopup="true"
            aria-label="Konto och logga ut"
          >
            <svg class="${sizeClasses}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="8.5" r="3.25" />
              <path d="M5 19c1.35-2.5 4-3.9 7-3.9s5.65 1.4 7 3.9" />
            </svg>
          </button>
          <div class="user-menu-dropdown absolute left-0 md:left-auto md:right-0 !mt-2 w-40 bg-white border border-gray-200 !py-2 hidden">
            <a href="/account" class="block px-4 py-2 text-sm font-semibold text-gray-800 !p-2 hover:bg-gray-50">Konto</a>
            <button class="sign-out-btn block w-full text-left px-4 py-2 text-sm font-semibold text-gray-800 !p-2 hover:bg-gray-50">Logga ut</button>
          </div>
        </div>
      `;
    };

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('feedzone-cart') || '[]');
      const count = cart.reduce((sum: number, item: any) => sum + item.quantity, 0);
      cartCountEls.forEach((el) => {
        el.textContent = count.toString();
        if (el.dataset.alwaysShow === 'true') {
          el.classList.remove('hidden');
        } else {
          el.classList.toggle('hidden', count === 0);
        }
      });
      if (mobileCartBtn) {
        mobileCartBtn.classList.toggle('has-count', count > 0);
        mobileCartBtn.classList.toggle('no-count', count === 0);
        if (previousCartCount !== null && count > previousCartCount && count > 0) {
          mobileCartBtn.classList.remove('flash');
          mobileCartBtn.style.background = mobileCartFlashBg;
          // force reflow to restart animation
          // eslint-disable-next-line @typescript-eslint/no-unused-expressions
          mobileCartBtn.offsetWidth;
          mobileCartBtn.classList.add('flash');
          setTimeout(() => {
            mobileCartBtn.classList.remove('flash');
            if (mobileCartOriginalBg) {
              mobileCartBtn.style.background = mobileCartOriginalBg;
            }
          }, 320);
        } else if (count === 0 && mobileCartOriginalBg) {
          mobileCartBtn.style.background = mobileCartOriginalBg;
        }
      }
      previousCartCount = count;
    }

    function bindSignOutButtons() {
      document.querySelectorAll<HTMLButtonElement>('.sign-out-btn').forEach((button) => {
        button.addEventListener('click', async () => {
          await supabase.auth.signOut();
          window.location.href = '/';
        });
      });
    }

    async function checkAuth() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        authContainerIds.forEach((id) => {
          const container = document.getElementById(id);
          if (!container) return;

          if (session) {
            const variant = id === 'auth-buttons-mobile' ? 'mobile' : 'desktop';
            container.innerHTML = userMenuTemplate(variant);
          } else {
            container.innerHTML = id === 'auth-buttons-mobile' ? loginIconMobile : loginIconDesktop;
          }
        });

        bindSignOutButtons();
        setupUserMenus();
      } catch (error) {
        console.error('Auth check error:', error);
      }
    }

    function setupUserMenus() {
      const toggles = Array.from(document.querySelectorAll<HTMLButtonElement>('.user-menu-toggle'));
      toggles.forEach((toggle) => {
        const container = toggle.closest('.relative');
        const dropdown = container?.querySelector<HTMLElement>('.user-menu-dropdown');
        if (!dropdown || !container) return;

        const closeMenu = () => {
          dropdown.classList.add('hidden');
          toggle.setAttribute('aria-expanded', 'false');
        };

        toggle.addEventListener('click', (event) => {
          event.stopPropagation();
          const isHidden = dropdown.classList.toggle('hidden');
          toggle.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
        });

        document.addEventListener('click', (event) => {
          if (!container.contains(event.target as Node)) {
            closeMenu();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            closeMenu();
          }
        });
      });
    }

    function openMobileMenu() {
      if (!mobileOverlay || !mobilePanel || !menuToggle) return;
      mobileOverlay.classList.remove('hidden');
      requestAnimationFrame(() => {
        mobilePanel.classList.remove('-translate-x-full');
      });
      menuToggle.setAttribute('aria-expanded', 'true');
    }

    function closeMobileMenu() {
      if (!mobileOverlay || !mobilePanel || !menuToggle) return;
      mobilePanel.classList.add('-translate-x-full');
      menuToggle.setAttribute('aria-expanded', 'false');
      setTimeout(() => mobileOverlay.classList.add('hidden'), 300);
    }

    menuToggle?.addEventListener('click', openMobileMenu);
    menuClose?.addEventListener('click', closeMobileMenu);
    mobileOverlay?.addEventListener('click', (event) => {
      if (event.target === mobileOverlay) {
        closeMobileMenu();
      }
    });

    mobilePanel?.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', closeMobileMenu);
    });

    window.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeMobileMenu();
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) {
        closeMobileMenu();
      }
    });

    updateCartCount();
    checkAuth();

    // Listen for cart updates
    window.addEventListener('storage', updateCartCount);
    window.addEventListener('cart-updated', updateCartCount);
  }
</script>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Force horizontal breathing room */
  .nav-shell {
    padding-left: 0.8rem !important;
    padding-right: 0.8rem !important;
  }

  @media (min-width: 768px) {
    .nav-shell {
      padding-left: 2rem !important;
      padding-right: 2rem !important;
    }
  }

  @media (min-width: 1024px) {
    .nav-shell {
      padding-left: 3rem !important;
      padding-right: 3rem !important;
    }
  }

  /* Force panel padding/spacing if global styles override */
  .mobile-menu-panel {
    padding-left: 1.25rem !important;
    padding-right: 1.25rem !important;
  }

  .mobile-menu-panel summary,
  .mobile-menu-panel a {
    padding-left: 1.25rem !important;
    padding-right: 1.25rem !important;
  }

  /* Ensure the overlay sits above any floating CTAs */
  #mobile-menu-overlay {
    z-index: 999 !important;
  }

  /* Extra indent for subcategory links */
  .mobile-menu-panel .subcategory {
    margin-left: 0.5rem !important;
  }

  /* Mobile cart button states */
  .mobile-cart-btn {
    max-width: 120px;
    padding-right: 0.75rem !important;
    transition: max-width 0.2s ease, padding-right 0.2s ease, background 0.3s ease;
  }

  .mobile-cart-btn.has-count {
    max-width: 170px;
    padding-right: 3.4rem !important;
  }

  .mobile-cart-btn.no-count [data-cart-count] {
    display: none !important;
  }

  .mobile-cart-btn.flash {
    animation: cart-flash-bg 0.32s ease;
  }

  @keyframes cart-flash-bg {
    0% {
      filter: brightness(1.05);
    }
    50% {
      filter: brightness(1.2);
    }
    100% {
      filter: brightness(1);
    }
  }

  /* Force hamburger to use primary color */
  .menu-toggle-btn,
  .menu-toggle-icon {
    color: var(--color-primary, #2C5F2D) !important;
  }
</style>

